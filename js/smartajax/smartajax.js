(function(a,b,c){function d(){}function f(){d.currentRequest=false;d._proceed=a.extend({},d._proceedTemplate)}function g(a,b){var c="";var d=true;for(var e=0;e<a.length;e++){if(!d)c+=b;d=false;c+=a[e]}return c}function h(a,b){for(var c=0;c<b.length;c++)if(b[c]==a)return true;return false}function j(a,b){for(var c=0;c<b.length;c++)if(a.is(b[c].selector))return b[c];return false}function k(b){var c=b.serialize();var d;d=a("input[name][type=submit].SmartAjax_clicked",b);if(d.length==0)d=a("input[name][type=submit]",b);if(d.length==0)return c;var e=d.attr("name")+"="+d.val();if(c.length>0)c+="&"+e;else c=e;return c}function l(a,b){if(a.indexOf("?")>0)a=a.substring(0,a.indexOf("?"));return a+"?"+b}var e;d.supported=window.History.enabled;d.enabled=true;d.html4=true;d.isAbsolute=new RegExp("^https?://","i");d.hasProtocol=new RegExp("^([a-z+]+)://","i");d.contentTypeMatch=/([a-z0-9\*\.\-]+)\/([a-z0-9\*\.\-]+)/i;d.isDebug=false;d.linkFilter=["jpe?g","png","gif","bmp","swf","mp3","flv","mp4","wmv","wav","flac","midi","txt","pdf","pptx?","xlsx?","odt","odp","ods","ppsx?","csv","css","js","vbs","djvu","zip","rar","7zip","tar","gz","tgz","bin","avi","mkv","3gp","sub","srt","diff"];d.allowedTypes=["","text/html","text/xml","text/plain"];d.root=b.getRootUrl().replace(/\/$/,"");d.options={cache:false,timeout:5,reload:false,replace:false,history:true,analytics:true,containers:[{selector:"#content, article, #article, .article, #post, .post",ifNotFound:"reload"}],before:function(a){d.proceed()},success:function(a){d.proceed()},error:function(a){window.location=a},done:function(a,b){}};d.state=b.getState();d.currentRequest=false;d.instanceOptions=d.options;d.isManual=false;d._binds=[];d._formbinds=[];d._proceedTemplate={url:"",step:0,data:"",method:"get",vars:{},replace:false};d._proceed={};f();d.setOptions=function(b){a.extend(d.options,b);d.instanceOptions=a.extend({},d.options,d.instanceOptions,b)};d.unbind=function(){d._binds=[]};d.unbindForms=function(){d._formbinds=[]};d.bind=function(a,b){d._binds.unshift({selector:a,options:b})};d.bindForms=function(a,b){d._formbinds.unshift({selector:a,options:b})};d._init=function(){a(document).bind("click.smartajax",function(b){if(!b.isDefaultPrevented()){var c=a(b.target);if(!c.is("a")){c=c.parents("a:first");if(c.length==0)return true}var e=j(c,d._binds);if(e===false)return true;var f=d.handle(c,e.options);if(f===false)b.preventDefault();return f}});a(document).bind("submit.smartajax",function(b){if(!b.isDefaultPrevented()){var c=a(b.target);if(!c.is("form")){c=c.filter("input[type=submit]").parents("form:first");if(c.length==0)return true}var e=j(c,d._formbinds);if(e===false)return true;var f=d.handleForm(c,e.options);if(f===false)b.preventDefault();return f}});a("form input[type=submit]").live("click",function(){a("input[type=submit]",a(this).parents("form")).removeClass("SmartAjax_clicked");a(this).addClass("SmartAjax_clicked")})};d.handle=function(b,c){$element=a(b).filter("a:ajaxlink").filter(":first");if($element.length==0)return true;if(d.isDebug)console.log("SmartAjax: Handling ",$element);return!d.load($element.attr("href"),c)};d.handleForm=function(b,e){$element=a(b).filter(":ajaxform").filter(":first");if($element.length==0)return true;if(d.isDebug)console.log("SmartAjax: Handling form ",$element);if($element.find("input[type=file]").length>0){if($element.attr("action")==c||$element.attr("action").length==0)$element.attr("action",d.state.url);return true}var f=k($element);var g="get";if($element.attr("method").length>0&&$element.attr("method").toLowerCase()=="post")g="post";var h=d.state.url;if($element.attr("action")!=null&&$element.attr("action").length>0)h=$element.attr("action");if(typeof e!=="object")e={};if(g!="get")e.replace=true;else{h=l(h,f);f={}}e.reload=true;return!d.load(h,e,g,f)};d.load=function(e,g,h,i){if(h==c)h="get";if(i==c)i={};d.isManual=true;e=b.getFullUrl(e||"");d.instanceOptions=a.extend({},d.options,g);if(!d.instanceOptions.reload&&e==d.state.url)return true;f();d._proceed.url=e;d._proceed.step=1;d._proceed.method=h;d._proceed.vars=i;var j=d.instanceOptions.before(e);if(j===false){f();return false}return true};d.proceed=function(){var g=d;var h=g._proceed.url;if(g._proceed.step==0||h.length==0)return false;if(g._proceed.step==1){e=document.title;if(!g.instanceOptions.history)b.replaceState({rand:Math.random()},null,g.state.url);else if(g.instanceOptions.replace&&g.instanceOptions.reload&&h==g.state.url)b.replaceState({rand:Math.random()},null,g._proceed.url);else b.pushState(null,null,g._proceed.url)}else if(g._proceed.step==3){d.load_internal(d._proceed.url)}else if(g._proceed.step==2){var j=g._proceed.data.replace(/<\!DOCTYPE[^\>]*>/i,"").replace(/<(html|head|body|title)( ([^\>]*))?\>/gi,'<div id="smartajax-$1" style="display:none;" $2>').replace(/<(meta|script|link)( ([^\>]*))?\>/gi,'<div class="smartajax-meta smartajax-$1" style="display:none;" $2>').replace(/<\/(html|head|body|title|meta|script|link)\>/gi,"</div>");if(g.isDebug)console.log("SmartAjax: handling data from ",h);var k=a(j);var l=k.find("#smartajax-title");a("body").attr("class",k.find("#smartajax-body").andSelf().filter("#smartajax-body").attr("class"));if(l.length>0)document.title=l.text();var m=[];for(i=0;i<g.instanceOptions.containers.length;i++){var n=g.instanceOptions.containers[i];var o=k.find(n.selector).andSelf().filter(n.selector).filter(":first");if(o.length==0){if(n.ifNotFound==c)n.ifNotFound="reload";if(typeof n.ifNotFound==="function")n.ifNotFound(n,a(document).find(n.selector));else if(n.ifNotFound=="reload"){window.location=h;return false}else if(n.ifNotFound=="empty")a(document).find(n.selector).empty();else if(n.ifNotFound=="hide")a(document).find(n.selector).hide();else if(n.ifNotFound=="keep")continue}else{var p=a(document).find(n.selector);p.html(o.html());if(n.showIfFound&&p.is(":hidden"))p.show();d.runScripts(p.find(".smartajax-script"));m.push(n)}o.remove()}var q=k.filter(".smartajax-script");a("body").append(q);d.runScripts(q);if(g.instanceOptions.analytics!==false){if(typeof g.instanceOptions.analytics==="object")g.instanceOptions.analytics.push(["_trackPageview",b.getShortUrl(h)]);else if(window._gaq!=c)window._gaq.push(["_trackPageview",b.getShortUrl(h)]);else if(window.pageTracker!=c)window.pageTracker._trackPageview(b.getShortUrl(h))}if(g.isDebug)console.log("SmartAjax: done with ",h);f();g.instanceOptions.done(h,m)}};d.runScripts=function(b){b.each(function(){var b=a(this);var c=b.html();var d=document.createElement("script");if(b.attr("type")!=null)d.setAttribute("type",a(this).attr("type"));if(b.attr("src")!=null)d.setAttribute("src",a(this).attr("src"));if(c.length>0){if(a.browser.msie){if(a.browser.version<8)window.execScript(c);else{d.text=c;b.after(d);b.remove()}}else{var e=document.createTextNode(c);d.appendChild(e);b.after(d);b.remove()}}})};d.handleChangeState=function(){var a=b.getState();document.title=e;d.state=a;if(d.isDebug)console.log("SmartAjax: State changed!",a);if(!d.isManual){f();d.instanceOptions=d.options;d._proceed.url=d.state.url;d._proceed.step=3;var c=d.instanceOptions.before(d.state.url);if(c===false)f()}else d.load_internal(d._proceed.url);d.isManual=false;return true};d.load_internal=function(b){var c=d;if(c.currentRequest!==false)d.abort(false);c.currentRequest=a.ajax(b,{cache:c.instanceOptions.cache,timeout:c.instanceOptions.timeout*1e3,type:c._proceed.method.toUpperCase(),data:c._proceed.vars,beforeSend:function(a,b){a.setRequestHeader("Accept","text/html")},error:function(a,d,e){if(c.currentRequest===false)return;if(c.isDebug)console.log("SmartAjax: error loading ",b);f();c.instanceOptions.error(b)},success:function(a,d,e){c._proceed.step=2;c._proceed.url=b;c._proceed.data=a;c.instanceOptions.success(b)},onreadystatechange:function(b,c){if(!a.browser.msie||a.browser.msie&&a.browser.version>=9){if((b.readyState==2||b.readyState==3)&&b.getResponseHeader("Content-Type").length>0){var e=b.getResponseHeader("Content-Type").match(d.contentTypeMatch);if(!h(e[0],d.allowedTypes))d.abort(true)}}}})};d.abort=function(a){if(a==c)a=true;if(d.currentRequest!==false){var b=d.currentRequest;if(!a)d.currentRequest=false;b.abort();f()}};a.expr[":"].ajaxlink=function(b,c,e,f){var h=a(b);var i=d;if(!h.is("a"))return false;var j=h.attr("href");if(typeof j==="undefined"||j===false)return false;var k=new RegExp("\\.("+g(i.linkFilter,"|")+")(#.*)?$","i");if(k.test(j)||j.substr(0,1)=="#"||j.substr(0,11)=="javascript:")return false;else if(i.isAbsolute.test(j))return j.substr(0,i.root.length)==i.root;else if(i.hasProtocol.test(j))return false;else return true};a.expr[":"].ajaxform=function(b,c,e,f){var g=a(b);var h=d;if(!g.is("form"))return false;var i=g.attr("action")||"";if(h.isAbsolute.test(i))return i.substr(0,h.root.length)==h.root;else if(h.hasProtocol.test(i))return false;else return true};if(!a.browser.msie||a.browser.msie&&a.browser.version>=9){a.ajaxPrefilter(function(a,b,c){if(a.onreadystatechange){var d=a.xhr;a.xhr=function(){function e(){a.onreadystatechange(b,c)}var b=d.apply(this,arguments);if(b.addEventListener){b.addEventListener("readystatechange",e,false)}else{setTimeout(function(){var a=b.onreadystatechange;if(a){b.onreadystatechange=function(){e();a.apply(this,arguments)}}},0)}return b}}})}window.SmartAjax=d;d._init();b.Adapter.bind(window,"statechange",d.handleChangeState)})(window.jQuery,window.History)