(function(a,b){"use strict";var c=a.console||b,d=a.document,e=a.navigator,f=a.sessionStorage||false,g=a.setTimeout,h=a.clearTimeout,i=a.setInterval,j=a.clearInterval,k=a.JSON,l=a.alert,m=a.History=a.History||{},n=a.history;k.stringify=k.stringify||k.encode;k.parse=k.parse||k.decode;if(typeof m.init!=="undefined"){throw new Error("History.js Core has already been loaded...")}m.init=function(){if(typeof m.Adapter==="undefined"){return false}if(typeof m.initCore!=="undefined"){m.initCore()}if(typeof m.initHtml4!=="undefined"){m.initHtml4()}return true};m.initCore=function(){if(typeof m.initCore.initialized!=="undefined"){return false}else{m.initCore.initialized=true}m.options=m.options||{};m.options.hashChangeInterval=m.options.hashChangeInterval||100;m.options.safariPollInterval=m.options.safariPollInterval||500;m.options.doubleCheckInterval=m.options.doubleCheckInterval||500;m.options.storeInterval=m.options.storeInterval||1e3;m.options.busyDelay=m.options.busyDelay||250;m.options.debug=m.options.debug||false;m.options.initialTitle=m.options.initialTitle||d.title;m.intervalList=[];m.clearAllIntervals=function(){var a,b=m.intervalList;if(typeof b!=="undefined"&&b!==null){for(a=0;a<b.length;a++){j(b[a])}m.intervalList=null}};m.debug=function(){if(m.options.debug||false){m.log.apply(m,arguments)}};m.log=function(){var a=!(typeof c==="undefined"||typeof c.log==="undefined"||typeof c.log.apply==="undefined"),b=d.getElementById("log"),e,f,g,h,i;if(a){h=Array.prototype.slice.call(arguments);e=h.shift();if(typeof c.debug!=="undefined"){c.debug.apply(c,[e,h])}else{c.log.apply(c,[e,h])}}else{e="\n"+arguments[0]+"\n"}for(f=1,g=arguments.length;f<g;++f){i=arguments[f];if(typeof i==="object"&&typeof k!=="undefined"){try{i=k.stringify(i)}catch(j){}}e+="\n"+i+"\n"}if(b){b.value+=e+"\n-----\n";b.scrollTop=b.scrollHeight-b.clientHeight}else if(!a){l(e)}return true};m.getInternetExplorerMajorVersion=function(){var a=m.getInternetExplorerMajorVersion.cached=typeof m.getInternetExplorerMajorVersion.cached!=="undefined"?m.getInternetExplorerMajorVersion.cached:function(){var a=3,b=d.createElement("div"),c=b.getElementsByTagName("i");while((b.innerHTML="<!--[if gt IE "+ ++a+"]><i></i><![endif]-->")&&c[0]){}return a>4?a:false}();return a};m.isInternetExplorer=function(){var a=m.isInternetExplorer.cached=typeof m.isInternetExplorer.cached!=="undefined"?m.isInternetExplorer.cached:Boolean(m.getInternetExplorerMajorVersion());return a};m.emulated={pushState:!Boolean(a.history&&a.history.pushState&&a.history.replaceState&&!(/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(e.userAgent)||/AppleWebKit\/5([0-2]|3[0-2])/i.test(e.userAgent))),hashChange:Boolean(!("onhashchange"in a||"onhashchange"in d)||m.isInternetExplorer()&&m.getInternetExplorerMajorVersion()<8)};m.enabled=!m.emulated.pushState;m.bugs={setHash:Boolean(!m.emulated.pushState&&e.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(e.userAgent)),safariPoll:Boolean(!m.emulated.pushState&&e.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(e.userAgent)),ieDoubleCheck:Boolean(m.isInternetExplorer()&&m.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(m.isInternetExplorer()&&m.getInternetExplorerMajorVersion()<7)};m.isEmptyObject=function(a){for(var b in a){return false}return true};m.cloneObject=function(a){var b,c;if(a){b=k.stringify(a);c=k.parse(b)}else{c={}}return c};m.getRootUrl=function(){var a=d.location.protocol+"//"+(d.location.hostname||d.location.host);if(d.location.port||false){a+=":"+d.location.port}a+="/";return a};m.getBaseHref=function(){var a=d.getElementsByTagName("base"),b=null,c="";if(a.length===1){b=a[0];c=b.href.replace(/[^\/]+$/,"")}c=c.replace(/\/+$/,"");if(c)c+="/";return c};m.getBaseUrl=function(){var a=m.getBaseHref()||m.getBasePageUrl()||m.getRootUrl();return a};m.getPageUrl=function(){var a=m.getState(false,false),b=(a||{}).url||m.getLocationHref(),c;c=b.replace(/\/+$/,"").replace(/[^\/]+$/,function(a,b,c){return/\./.test(a)?a:a+"/"});return c};m.getBasePageUrl=function(){var a=m.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(a,b,c){return/[^\/]$/.test(a)?"":a}).replace(/\/+$/,"")+"/";return a};m.getFullUrl=function(a,b){var c=a,d=a.substring(0,1);b=typeof b==="undefined"?true:b;if(/[a-z]+\:\/\//.test(a)){}else if(d==="/"){c=m.getRootUrl()+a.replace(/^\/+/,"")}else if(d==="#"){c=m.getPageUrl().replace(/#.*/,"")+a}else if(d==="?"){c=m.getPageUrl().replace(/[\?#].*/,"")+a}else{if(b){c=m.getBaseUrl()+a.replace(/^(\.\/)+/,"")}else{c=m.getBasePageUrl()+a.replace(/^(\.\/)+/,"")}}return c.replace(/\#$/,"")};m.getShortUrl=function(a){var b=a,c=m.getBaseUrl(),d=m.getRootUrl();if(m.emulated.pushState){b=b.replace(c,"")}b=b.replace(d,"/");if(m.isTraditionalAnchor(b)){b="./"+b}b=b.replace(/^(\.\/)+/g,"./").replace(/\#$/,"");return b};m.getLocationHref=function(a){a=a||d;if(a.URL===a.location.href)return a.location.href;if(a.location.href===decodeURIComponent(a.URL))return a.URL;if(a.location.hash&&decodeURIComponent(a.location.href.replace(/^[^#]+/,""))===a.location.hash)return a.location.href;return a.URL||a.location.href};m.store={};m.idToState=m.idToState||{};m.stateToId=m.stateToId||{};m.urlToId=m.urlToId||{};m.storedStates=m.storedStates||[];m.savedStates=m.savedStates||[];m.normalizeStore=function(){m.store.idToState=m.store.idToState||{};m.store.urlToId=m.store.urlToId||{};m.store.stateToId=m.store.stateToId||{}};m.getState=function(a,b){if(typeof a==="undefined"){a=true}if(typeof b==="undefined"){b=true}var c=m.getLastSavedState();if(!c&&b){c=m.createStateObject()}if(a){c=m.cloneObject(c);c.url=c.cleanUrl||c.url}return c};m.getIdByState=function(a){var b=m.extractId(a.url),c;if(!b){c=m.getStateString(a);if(typeof m.stateToId[c]!=="undefined"){b=m.stateToId[c]}else if(typeof m.store.stateToId[c]!=="undefined"){b=m.store.stateToId[c]}else{while(true){b=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof m.idToState[b]==="undefined"&&typeof m.store.idToState[b]==="undefined"){break}}m.stateToId[c]=b;m.idToState[b]=a}}return b};m.normalizeState=function(a){var b,c;if(!a||typeof a!=="object"){a={}}if(typeof a.normalized!=="undefined"){return a}if(!a.data||typeof a.data!=="object"){a.data={}}b={};b.normalized=true;b.title=a.title||"";b.url=m.getFullUrl(a.url?decodeURIComponent(a.url):m.getLocationHref());b.hash=m.getShortUrl(b.url);b.data=m.cloneObject(a.data);b.id=m.getIdByState(b);b.cleanUrl=b.url.replace(/\??\&_suid.*/,"");b.url=b.cleanUrl;c=!m.isEmptyObject(b.data);if(b.title||c){b.hash=m.getShortUrl(b.url).replace(/\??\&_suid.*/,"");if(!/\?/.test(b.hash)){b.hash+="?"}b.hash+="&_suid="+b.id}b.hashedUrl=m.getFullUrl(b.hash);if((m.emulated.pushState||m.bugs.safariPoll)&&m.hasUrlDuplicate(b)){b.url=b.hashedUrl}return b};m.createStateObject=function(a,b,c){var d={data:a,title:b,url:encodeURIComponent(c||"")};d=m.normalizeState(d);return d};m.getStateById=function(a){a=String(a);var c=m.idToState[a]||m.store.idToState[a]||b;return c};m.getStateString=function(a){var b,c,d;b=m.normalizeState(a);c={data:b.data,title:a.title,url:a.url};d=k.stringify(c);return d};m.getStateId=function(a){var b,c;b=m.normalizeState(a);c=b.id;return c};m.getHashByState=function(a){var b,c;b=m.normalizeState(a);c=b.hash;return c};m.extractId=function(a){var b,c,d;c=/(.*)\&_suid=([0-9]+)$/.exec(a);d=c?c[1]||a:a;b=c?String(c[2]||""):"";return b||false};m.isTraditionalAnchor=function(a){var b=!/[\/\?\.]/.test(a);return b};m.extractState=function(a,b){var c=null,d,e;b=b||false;d=m.extractId(a);if(d){c=m.getStateById(d)}if(!c){e=m.getFullUrl(a);d=m.getIdByUrl(e)||false;if(d){c=m.getStateById(d)}if(!c&&b&&!m.isTraditionalAnchor(a)){c=m.createStateObject(null,null,e)}}return c};m.getIdByUrl=function(a){var c=m.urlToId[a]||m.store.urlToId[a]||b;return c};m.getLastSavedState=function(){return m.savedStates[m.savedStates.length-1]||b};m.getLastStoredState=function(){return m.storedStates[m.storedStates.length-1]||b};m.hasUrlDuplicate=function(a){var b=false,c;c=m.extractState(a.url);b=c&&c.id!==a.id;return b};m.storeState=function(a){m.urlToId[a.url]=a.id;m.storedStates.push(m.cloneObject(a));return a};m.isLastSavedState=function(a){var b=false,c,d,e;if(m.savedStates.length){c=a.id;d=m.getLastSavedState();e=d.id;b=c===e}return b};m.saveState=function(a){if(m.isLastSavedState(a)){return false}m.savedStates.push(m.cloneObject(a));return true};m.getStateByIndex=function(a){var b=null;if(typeof a==="undefined"){b=m.savedStates[m.savedStates.length-1]}else if(a<0){b=m.savedStates[m.savedStates.length+a]}else{b=m.savedStates[a]}return b};m.getHash=function(a){if(!a)a=d.location;var b=a.href.replace(/^[^#]*/,"");return b.substr(1)};m.unescapeHash=function(a){var b=m.normalizeHash(a);b=decodeURIComponent(b);return b};m.normalizeHash=function(a){var b=a.replace(/[^#]*#/,"").replace(/#.*/,"");return b};m.setHash=function(a,b){var c,e;if(b!==false&&m.busy()){m.pushQueue({scope:m,callback:m.setHash,args:arguments,queue:b});return false}m.busy(true);c=m.extractState(a,true);if(c&&!m.emulated.pushState){m.pushState(c.data,c.title,c.url,false)}else if(m.getHash()!==a){if(m.bugs.setHash){e=m.getPageUrl();m.pushState(null,null,e+"#"+a,false)}else{d.location.hash=a}}return m};m.escapeHash=function(b){var c=m.normalizeHash(b);c=a.encodeURIComponent(c);if(!m.bugs.hashEscape){c=c.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")}return c};m.getHashByUrl=function(a){var b=String(a).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");b=m.unescapeHash(b);return b};m.setTitle=function(a){var b=a.title,c;if(!b){c=m.getStateByIndex(0);if(c&&c.url===a.url){b=c.title||m.options.initialTitle}}try{d.getElementsByTagName("title")[0].innerHTML=b.replace("<","<").replace(">",">").replace(" & "," & ")}catch(e){}d.title=b;return m};m.queues=[];m.busy=function(a){if(typeof a!=="undefined"){m.busy.flag=a}else if(typeof m.busy.flag==="undefined"){m.busy.flag=false}if(!m.busy.flag){h(m.busy.timeout);var b=function(){var a,c,d;if(m.busy.flag)return;for(a=m.queues.length-1;a>=0;--a){c=m.queues[a];if(c.length===0)continue;d=c.shift();m.fireQueueItem(d);m.busy.timeout=g(b,m.options.busyDelay)}};m.busy.timeout=g(b,m.options.busyDelay)}return m.busy.flag};m.busy.flag=false;m.fireQueueItem=function(a){return a.callback.apply(a.scope||m,a.args||[])};m.pushQueue=function(a){m.queues[a.queue||0]=m.queues[a.queue||0]||[];m.queues[a.queue||0].push(a);return m};m.queue=function(a,b){if(typeof a==="function"){a={callback:a}}if(typeof b!=="undefined"){a.queue=b}if(m.busy()){m.pushQueue(a)}else{m.fireQueueItem(a)}return m};m.clearQueue=function(){m.busy.flag=false;m.queues=[];return m};m.stateChanged=false;m.doubleChecker=false;m.doubleCheckComplete=function(){m.stateChanged=true;m.doubleCheckClear();return m};m.doubleCheckClear=function(){if(m.doubleChecker){h(m.doubleChecker);m.doubleChecker=false}return m};m.doubleCheck=function(a){m.stateChanged=false;m.doubleCheckClear();if(m.bugs.ieDoubleCheck){m.doubleChecker=g(function(){m.doubleCheckClear();if(!m.stateChanged){a()}return true},m.options.doubleCheckInterval)}return m};m.safariStatePoll=function(){var b=m.extractState(m.getLocationHref()),c;if(!m.isLastSavedState(b)){c=b}else{return}if(!c){c=m.createStateObject()}m.Adapter.trigger(a,"popstate");return m};m.back=function(a){if(a!==false&&m.busy()){m.pushQueue({scope:m,callback:m.back,args:arguments,queue:a});return false}m.busy(true);m.doubleCheck(function(){m.back(false)});n.go(-1);return true};m.forward=function(a){if(a!==false&&m.busy()){m.pushQueue({scope:m,callback:m.forward,args:arguments,queue:a});return false}m.busy(true);m.doubleCheck(function(){m.forward(false)});n.go(1);return true};m.go=function(a,b){var c;if(a>0){for(c=1;c<=a;++c){m.forward(b)}}else if(a<0){for(c=-1;c>=a;--c){m.back(b)}}else{throw new Error("History.go: History.go requires a positive or negative integer passed.")}return m};if(m.emulated.pushState){var o=function(){};m.pushState=m.pushState||o;m.replaceState=m.replaceState||o}else{m.onPopState=function(b,c){var d=false,e=false,f,g;m.doubleCheckComplete();f=m.getHash();if(f){g=m.extractState(f||m.getLocationHref(),true);if(g){m.replaceState(g.data,g.title,g.url,false)}else{m.Adapter.trigger(a,"anchorchange");m.busy(false)}m.expectedStateId=false;return false}d=m.Adapter.extractEventData("state",b,c)||false;if(d){e=m.getStateById(d)}else if(m.expectedStateId){e=m.getStateById(m.expectedStateId)}else{e=m.extractState(m.getLocationHref())}if(!e){e=m.createStateObject(null,null,m.getLocationHref())}m.expectedStateId=false;if(m.isLastSavedState(e)){m.busy(false);return false}m.storeState(e);m.saveState(e);m.setTitle(e);m.Adapter.trigger(a,"statechange");m.busy(false);return true};m.Adapter.bind(a,"popstate",m.onPopState);m.pushState=function(b,c,d,e){if(m.getHashByUrl(d)&&m.emulated.pushState){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(e!==false&&m.busy()){m.pushQueue({scope:m,callback:m.pushState,args:arguments,queue:e});return false}m.busy(true);var f=m.createStateObject(b,c,d);if(m.isLastSavedState(f)){m.busy(false)}else{m.storeState(f);m.expectedStateId=f.id;n.pushState(f.id,f.title,f.url);m.Adapter.trigger(a,"popstate")}return true};m.replaceState=function(b,c,d,e){if(m.getHashByUrl(d)&&m.emulated.pushState){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(e!==false&&m.busy()){m.pushQueue({scope:m,callback:m.replaceState,args:arguments,queue:e});return false}m.busy(true);var f=m.createStateObject(b,c,d);if(m.isLastSavedState(f)){m.busy(false)}else{m.storeState(f);m.expectedStateId=f.id;n.replaceState(f.id,f.title,f.url);m.Adapter.trigger(a,"popstate")}return true}}if(f){try{m.store=k.parse(f.getItem("History.store"))||{}}catch(p){m.store={}}m.normalizeStore()}else{m.store={};m.normalizeStore()}m.Adapter.bind(a,"beforeunload",m.clearAllIntervals);m.Adapter.bind(a,"unload",m.clearAllIntervals);m.saveState(m.storeState(m.extractState(m.getLocationHref(),true)));if(f){m.onUnload=function(){var a,b;try{a=k.parse(f.getItem("History.store"))||{}}catch(c){a={}}a.idToState=a.idToState||{};a.urlToId=a.urlToId||{};a.stateToId=a.stateToId||{};for(b in m.idToState){if(!m.idToState.hasOwnProperty(b)){continue}a.idToState[b]=m.idToState[b]}for(b in m.urlToId){if(!m.urlToId.hasOwnProperty(b)){continue}a.urlToId[b]=m.urlToId[b]}for(b in m.stateToId){if(!m.stateToId.hasOwnProperty(b)){continue}a.stateToId[b]=m.stateToId[b]}m.store=a;m.normalizeStore();f.setItem("History.store",k.stringify(a))};m.intervalList.push(i(m.onUnload,m.options.storeInterval));m.Adapter.bind(a,"beforeunload",m.onUnload);m.Adapter.bind(a,"unload",m.onUnload)}if(!m.emulated.pushState){if(m.bugs.safariPoll){m.intervalList.push(i(m.safariStatePoll,m.options.safariPollInterval))}if(e.vendor==="Apple Computer, Inc."||(e.appCodeName||"")==="Mozilla"){m.Adapter.bind(a,"hashchange",function(){m.Adapter.trigger(a,"popstate")});if(m.getHash()){m.Adapter.onDomLoad(function(){m.Adapter.trigger(a,"hashchange")})}}}};m.init()})(window)